<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Simplifying JSON Response Mocks With Jinja - sasheldon.com</title>
  <meta name="author" content="Steven Sheldon">

  
  <meta name="description" content="For documenting and testing large APIs, response mocks can be a very useful tool. They not only provide examples for the users of your API, but the...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sasheldon.com/blog/2013/12/14/simplifying-json-response-mocks-with-jinja/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="sasheldon.com" type="application/atom+xml">

  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
  <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">sasheldon.com</a></h1>
  
</hgroup>
</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>


<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sasheldon.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>


<ul class="main-navigation">
  <li><a href="/">About</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
<header>
  
    <h1 class="entry-title">Simplifying JSON Response Mocks With Jinja</h1>
  
  
    <p class="meta">
      








  


<time datetime="2013-12-14T15:43:01-06:00"  class="updated" >Dec 14, 2013</time>
      
    </p>
  
</header>


  <div class="entry-content"><p>For documenting and testing large APIs, response mocks can be a very useful
tool. They not only provide examples for the users of your API, but they can be
used in automated tests as if you had received real data without actually
hitting the network.</p>

<p>Creating and maintaining a large collection of response mocks can be greatly
simplified by preprocessing them with a template engine like Python&rsquo;s
<a href="http://jinja.pocoo.org/">Jinja</a>. Although this adds another step to your build
process, it allows some really useful functionality!</p>

<!-- more -->

<h3>Variables</h3>

<p>One of the first advantages of processing response mocks with Jinja is that
we can use <a href="http://jinja.pocoo.org/docs/templates/#variables">variables</a> when
generating them.
For example, let&rsquo;s consider an API that can respond with information about a
person. One of our mock responses is a Person object, like so:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
    <span class="s2">&quot;first_name&quot;</span><span class="o">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
    <span class="s2">&quot;last_name&quot;</span><span class="o">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
    <span class="s2">&quot;phone_number&quot;</span><span class="o">:</span> <span class="s2">&quot;415 555-1234&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>However, developers in different locations require that the phone number have a
local area code. In this situation, we could simply change the mock to be:</p>
<div class="highlight"><pre><code class="language-js+jinja" data-lang="js+jinja"><span class="p">{</span>
    <span class="s2">&quot;first_name&quot;</span><span class="o">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
    <span class="s2">&quot;last_name&quot;</span><span class="o">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
    <span class="s2">&quot;phone_number&quot;</span><span class="o">:</span> <span class="s2">&quot;</span><span class="cp">{{</span> <span class="nv">area_code</span> <span class="cp">}}</span><span class="s2"> 555-1234&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>Now, we only need to process the mocks through Jinja with the area code in
the context to generate mocks using the new area code. We can render the mock
with <code>area_code=&#39;312&#39;</code> in the context to get the phone number <code>&quot;312 555-1234&quot;</code>.</p>

<h3>Conditionals</h3>

<p>We can further take advantage of Jinja to template our mocks using more
complicated control flows. For example, suppose that we wanted to format our
mock from the previous example to include a Person&rsquo;s last name sometimes, but
not in other cases. We can accomplish this simply in Jinja with an
<a href="http://jinja.pocoo.org/docs/templates/#if">if block</a>:</p>
<div class="highlight"><pre><code class="language-js+jinja" data-lang="js+jinja"><span class="p">{</span>
    <span class="s2">&quot;first_name&quot;</span><span class="o">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nv">last_names_included</span> <span class="cp">%}</span>
    <span class="s2">&quot;last_name&quot;</span><span class="o">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
    <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
    <span class="s2">&quot;phone_number&quot;</span><span class="o">:</span> <span class="s2">&quot;415 555-1234&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>If this mock is rendered with <code>last_names_included=True</code> in the context,
it will include the <code>last_name</code> field, and if not it will be absent!</p>

<h3>Including mocks</h3>

<p>The previous examples might feel a little contrived, but importing one mock
from another is one of the greatest benefits of Jinja.
A large API will likely have objects with a common scheme that are used in
multiple responses, and it can be very convenient and greatly simplify our
mocks if we can define an object once and reference it in many places.</p>

<p>Perhaps multiple responses from our example API include addresses in a common
format. We can provide an example address in its own file:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
    <span class="s2">&quot;street_address&quot;</span><span class="o">:</span> <span class="s2">&quot;21 2nd Street&quot;</span><span class="p">,</span>
    <span class="s2">&quot;city&quot;</span><span class="o">:</span> <span class="s2">&quot;New York&quot;</span><span class="p">,</span>
    <span class="s2">&quot;state&quot;</span><span class="o">:</span> <span class="s2">&quot;NY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;postal_code&quot;</span><span class="o">:</span> <span class="mi">10021</span>
<span class="p">}</span>
</code></pre></div>
<p>Then, in any response that includes an address, instead of copy-pasting this
example address or creating an entirely new address, we can simply include our
address in the mock with
<a href="http://jinja.pocoo.org/docs/templates/#include">Jinja&rsquo;s include tag</a>:</p>
<div class="highlight"><pre><code class="language-js+jinja" data-lang="js+jinja"><span class="p">{</span>
    <span class="s2">&quot;first_name&quot;</span><span class="o">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
    <span class="s2">&quot;last_name&quot;</span><span class="o">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
    <span class="s2">&quot;address&quot;</span><span class="o">:</span> <span class="cp">{%</span> <span class="k">include</span> <span class="s1">&#39;address.json&#39;</span> <span class="cp">%}</span><span class="p">,</span>
    <span class="s2">&quot;phone_number&quot;</span><span class="o">:</span> <span class="s2">&quot;415 555-1234&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>The include tag does not only let us avoid duplicating data; if each object is
stored in its own file, it can turn our response mocks into a simple
composition of objects where the structure is clear at a glance.</p>

<h3>Extending mocks</h3>

<p>I commonly need to create a response mock that is modified slightly from an
existing one, like a version of the response that has a parameter with a
different value or that specifies some optional parameters.
I think of this like JSON &ldquo;inheritance&rdquo;, where an object gets all the values
from a base object but can then override them.</p>

<p>With Jinja, we call allow this &ldquo;inheritance&rdquo; by creating a way to extend mocks.
We can simply model the changes we want and the base object as Python
<a href="http://docs.python.org/2/library/stdtypes.html#mapping-types-dict"><code>dict</code></a>s and
use the <a href="http://docs.python.org/2/library/stdtypes.html#dict.update"><code>update</code></a>
method to override the items in the base dictionary with our changes.
The dictionary of updates will be specified in JSON, so a function to return
the JSON that results from updating looks like this:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">json_update</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">updates</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div>
<p>We can then include this function in Jinja&rsquo;s context to access it within our
response mocks. This allows us to write an <code>extend_json</code>
<a href="http://jinja.pocoo.org/docs/templates/#macros">macro</a>:</p>
<div class="highlight"><pre><code class="language-jinja" data-lang="jinja"><span class="cp">{%</span> <span class="k">macro</span> <span class="nv">include_json</span><span class="o">(</span><span class="nv">path</span><span class="o">)</span> <span class="cp">%}{%</span> <span class="k">include</span> <span class="nv">path</span> <span class="cp">%}{%</span> <span class="k">endmacro</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">extend_json</span><span class="o">(</span><span class="nv">base_path</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">json_update</span><span class="o">(</span><span class="nv">include_json</span><span class="o">(</span><span class="nv">base_path</span><span class="o">),</span> <span class="nv">caller</span><span class="o">())</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">endmacro</span> <span class="cp">%}</span><span class="x"></span>
</code></pre></div>
<p>This macro will be called with the JSON updates as its body so that they are
accessible within the macro through the <code>caller()</code> function.
The <code>include_json</code> macro just allows us to use an included file as an argument
to the <code>json_update</code> function.</p>

<p>To see this macro in action, let&rsquo;s consider our Person object with an age
parameter:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
    <span class="s2">&quot;first_name&quot;</span><span class="o">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
    <span class="s2">&quot;last_name&quot;</span><span class="o">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
    <span class="s2">&quot;age&quot;</span><span class="o">:</span> <span class="mi">25</span><span class="p">,</span>
    <span class="s2">&quot;phone_number&quot;</span><span class="o">:</span> <span class="s2">&quot;415 555-1234&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>To create another Person object with a different age, we only have to do this:</p>
<div class="highlight"><pre><code class="language-js+jinja" data-lang="js+jinja"><span class="cp">{%</span> <span class="k">call</span> <span class="nv">extend_json</span><span class="o">(</span><span class="s1">&#39;person.json&#39;</span><span class="o">)</span> <span class="cp">%}</span>
<span class="p">{</span>
    <span class="s2">&quot;age&quot;</span><span class="o">:</span> <span class="mi">70</span>
<span class="p">}</span>
<span class="cp">{%</span> <span class="k">endcall</span> <span class="cp">%}</span>
</code></pre></div>
<p>It&rsquo;s useful to note that the <code>extend_json</code> macro must be available in this
file, so we&rsquo;ll likely need to
<a href="http://jinja.pocoo.org/docs/templates/#import">import</a> it from the file in
which it is declared.</p>

<p>The functionality of Jinja doesn&rsquo;t end with macros; after all, it&rsquo;s a
full-fledged template engine with many
<a href="http://jinja.pocoo.org/docs/templates/#list-of-builtin-filters">built-in filters</a>
and a powerful (if complicated)
<a href="http://jinja.pocoo.org/docs/extensions/">extension system</a>.
This article just covered the functionality that I&rsquo;ve found useful, but Jinja
can surely adapt to meet whatever your needs are.</p>
</div>
  
<footer>
  <p class="meta">
    
  

<span class="byline author vcard">Posted by <span class="fn">Steven Sheldon</span></span>

    








  


<time datetime="2013-12-14T15:43:01-06:00"  class="updated" >Dec 14, 2013</time>
    


  </p>
  
    <div class="sharing">
  
  
  
</div>

  
  <p class="meta">
    
      <a class="basic-alignment left" href="/blog/2013/07/07/waiting-for-octopress-2-successor/" title="Previous Post: Waiting for Octopress 2.0's Successor">&laquo; Waiting for Octopress 2.0's Successor</a>
    
    
      <a class="basic-alignment right" href="/blog/2014/11/28/interoperating-between-objective-c-and-rust/" title="Next Post: Interoperating Between Objective-C and Rust">Interoperating Between Objective-C and Rust &raquo;</a>
    
  </p>
</footer>


</article>

</div>

      
      <aside class="sidebar">
        <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/11/28/interoperating-between-objective-c-and-rust/">Interoperating Between Objective-C and Rust</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/14/simplifying-json-response-mocks-with-jinja/">Simplifying JSON Response Mocks With Jinja</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/07/waiting-for-octopress-2-successor/">Waiting for Octopress 2.0's Successor</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/15/octopress/">Octopress</a>
      </li>
    
  </ul>
</section>

      </aside>
      
    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Steven Sheldon -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
</footer>
  









</body>
</html>
